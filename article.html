<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="pageTitle">Loading...</title>
<style>
  :root{
    --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa4b2; --line:#1b2330;
    --brand:#f59e0b; --brand-2:#16a34a; --link:#93c5fd; --chip:#0f1720;
    --card:#0e141b; --accent:#ffe08a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{background:var(--bg);color:var(--ink);font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  a{color:var(--link)}
  img{max-width:100%;height:auto;display:block}
  .wrap{max-width:1120px;margin:auto;padding:20px}
  .content-wrap{max-width:784px;margin:auto;padding:20px}
  header,footer{background:#0a0f15;border-bottom:1px solid var(--line)}
  header .bar{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
  header .tag{color:var(--muted);font-size:14px}
  .hero{margin-top:24px;margin-bottom:32px;border-radius:12px;overflow:hidden}
  .title{font-weight:900;letter-spacing:-.01em;line-height:1.15;margin:20px 0 8px}
  .title.xl{font-size:clamp(28px,5vw,48px)}
  .date{color:var(--muted);font-style:italic;font-size:14px;margin-bottom:24px}
  .prose{font-size:18px;line-height:1.75}
  .prose p{margin:20px 0}
  .prose p:first-child{margin-top:0}
  .prose ol, .prose ul{padding-left:1.5rem;margin:20px 0}
  .prose li{margin:8px 0;line-height:1.65}
  .prose h2{margin-top:36px;margin-bottom:16px;font-size:28px;font-weight:800;line-height:1.3}
  .prose h3{margin-top:28px;margin-bottom:12px;font-size:22px;font-weight:700}
  .prose strong{font-weight:700;color:var(--ink)}
  
  /* Enhanced table styles with mobile responsiveness */
  .table-wrapper{overflow-x:auto;margin:24px 0;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  .prose table{width:100%;min-width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--line);font-size:15px}
  .prose th{background:var(--chip);padding:14px 16px;text-align:left;font-weight:600;border-bottom:2px solid var(--line);white-space:nowrap;color:var(--ink)}
  .prose td{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.05);color:var(--muted);vertical-align:top}
  .prose tbody tr:last-child td{border-bottom:none}
  .prose tbody tr:hover{background:rgba(255,255,255,0.03)}
  .prose tbody tr:nth-child(even){background:rgba(255,255,255,0.01)}
  
  /* Mobile-first responsive table */
  @media(max-width:768px){
    .table-wrapper{margin:20px -20px;border-radius:0;padding:0 20px}
    .prose table{font-size:14px;display:block}
    .prose thead{display:none}
    .prose tbody{display:block}
    .prose tr{display:block;margin-bottom:16px;background:var(--card);border:1px solid var(--line);border-radius:8px;padding:12px}
    .prose td{display:flex;justify-content:space-between;align-items:flex-start;padding:8px 0;border:none;text-align:right}
    .prose td:before{content:attr(data-label);font-weight:600;text-align:left;padding-right:12px;color:var(--ink);flex-shrink:0;max-width:50%}
    .prose td:last-child{border-bottom:none}
    .prose tbody tr:hover{background:var(--card);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  }
  
  /* Scrollable table indicator */
  .table-wrapper::-webkit-scrollbar{height:8px}
  .table-wrapper::-webkit-scrollbar-track{background:var(--chip);border-radius:4px}
  .table-wrapper::-webkit-scrollbar-thumb{background:var(--muted);border-radius:4px}
  .table-wrapper::-webkit-scrollbar-thumb:hover{background:var(--brand)}
  
  /* Better list styling */
  .prose ul li::marker{color:var(--brand)}
  .prose ol li::marker{color:var(--brand);font-weight:600}
  
  /* Blockquote styling */
  .prose blockquote{margin:24px 0;padding:16px 20px;background:var(--chip);border-left:4px solid var(--brand);border-radius:4px;font-style:italic}
  
  /* Code styling */
  .prose code{background:var(--chip);padding:2px 6px;border-radius:4px;font-size:0.9em;font-family:monospace}
  .prose pre{background:var(--chip);padding:16px;border-radius:8px;overflow-x:auto;margin:20px 0}
  .prose pre code{background:transparent;padding:0}
  .btn{display:inline-block;width:100%;text-align:center;font-weight:800;text-decoration:none;
       background:var(--brand);color:#000;padding:14px 18px;border-radius:10px;margin:14px 0;transition:.15s}
  .btn:hover{background:var(--brand-2);color:#fff}
  .zipbox{margin-top:24px}
  .zipbox h3{margin:0 0 10px;font-size:22px}
  .zips{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  @media(min-width:900px){.zips{grid-template-columns:repeat(8,minmax(0,1fr))}}
  .zip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;
       background:var(--chip);border:1px solid var(--line);font-weight:700;text-decoration:none}
  .notice{margin-top:24px;border:1px dashed var(--accent);background:#151b24;padding:16px;border-radius:12px;text-align:center}
  .ctaCard{margin-top:26px;background:var(--card);border:1px solid var(--line);padding:18px;border-radius:14px}
  .foot{color:#98a2b3;font-size:13px;margin-top:18px}
  .center{text-align:center}
  .logo{height:28px}
  .loading{text-align:center;padding:40px;color:var(--muted)}
  .error{background:#7f1d1d;color:#fca5a5;padding:20px;border-radius:12px;margin:20px 0}
</style>
</head>
<body>
<header>
  <div class="wrap bar">
    <a href="https://pennypincher.com"><img class="logo" src="logo.svg" alt="Penny Pincher"></a>
  </div>
</header>

<main class="content-wrap">
  <div id="loadingState" class="loading">Loading article...</div>
  <div id="errorState" class="error" style="display:none"></div>
  
  <div id="articleContent" style="display:none">
    <h1 class="title xl" id="title"></h1>
    <div class="date">Last Updated: <span id="date"></span></div>

    <div class="hero" id="heroContainer" style="display:none">
      <img id="featuredImage" alt="Article image">
    </div>

    <article class="prose" id="content"></article>

    <section class="zipbox" id="zipSection" style="display:none">
      <h3>ZIP Codes Eligible For Discounts:</h3>
      <div class="zips" id="zips"></div>
      <div class="notice">
        Don't see your ZIP? <a class="ctaLink" href="#" target="_blank" rel="noopener">Click here to check yours</a>.
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">
    <hr><br>
    <div class="center"><a href="https://pennypincher.com"><img class="logo" src="logo.svg" alt="Penny Pincher"></a></div>
    <p class="foot center">© 2025 PennyPincher.com. All Rights Reserved. &nbsp; <a href="/privacy-policy">Privacy</a> · <a href="/terms-of-use">Terms</a> · <a href="/contact">Contact</a></p>
  </div>
</footer>

<script type="module">
// Article Loader - Inline version that works with any slug
class ArticleLoader {
  constructor() {
    this.apiBase = 'https://strapi-advertorials-xrppc.ondigitalocean.app/api';
    this.apiToken = '7b1cdd7dec14d838179aa383e0686ccf4c171ddf1c0c256127108901d3885db31ca6548a478064cd9c6272beecf86bc2fb297c5185ceedd92b563131ddd3def956321421de8b6ef607b0c2b19f86edc6693ab6e02486ebd49d5c9366f1fead150cbc64938aa7f3ed630d311837c2c3b03ecfc79ad02b085eea50b251ba9f603c';
    this.articleData = null;
    this.geoData = {};
  }

  async init() {
    try {
      // Get slug from URL path - works with any path pattern
      const slug = this.getSlugFromPath();
      
      if (!slug) {
        this.showError('No article specified');
        return;
      }

      // Load geo data first
      await this.loadGeoData();
      
      // Load article from API
      await this.loadArticle(slug);
      
      // Render the article
      this.renderArticle();
      
      // Load ZIP codes
      this.loadZipCodes();
      
    } catch (error) {
      console.error('Error loading article:', error);
      this.showError('Failed to load article. Please try again later.');
    }
  }

  getSlugFromPath() {
    // Extract slug from URL path - handles both /slug and /articles/slug patterns
    const path = window.location.pathname;
    // Remove leading slash and any "articles/" prefix
    let slug = path.replace(/^\//, '').replace(/^articles\//, '');
    // Remove any trailing slashes or query params
    slug = slug.split('/')[0].split('?')[0];
    return slug || null;
  }

  async loadGeoData() {
    try {
      // Check URL params first
      const url = new URL(location.href);
      const stateFromUrl = url.searchParams.get('state');
      const cityFromUrl = url.searchParams.get('city');
      
      if (stateFromUrl) this.geoData.state = stateFromUrl;
      if (cityFromUrl) this.geoData.city = cityFromUrl;
      
      // Try to get from localStorage or API if not in URL
      if (!this.geoData.state || !this.geoData.city) {
        const cachedState = localStorage.getItem('geoState');
        const cachedCity = localStorage.getItem('geoCity');
        const cachedZip = localStorage.getItem('geoZipCode');
        
        if (cachedState) this.geoData.state = cachedState;
        if (cachedCity) this.geoData.city = cachedCity;
        if (cachedZip) this.geoData.zipCode = cachedZip;
        
        // If still missing, fetch from API
        if (!this.geoData.state || !this.geoData.city) {
          try {
            const response = await fetch('https://api.pennypincher.com/geo');
            if (response.ok) {
              const data = await response.json();
              if (data.state) {
                this.geoData.state = data.state;
                localStorage.setItem('geoState', data.state);
              }
              if (data.city) {
                this.geoData.city = data.city;
                localStorage.setItem('geoCity', data.city);
              }
              if (data.postal) {
                this.geoData.zipCode = data.postal;
                localStorage.setItem('geoZipCode', data.postal);
              }
            }
          } catch (e) {
            console.warn('Could not fetch geo data:', e);
          }
        }
      }
      
      // Set defaults if still missing
      if (!this.geoData.state) this.geoData.state = 'Your State';
      if (!this.geoData.city) this.geoData.city = 'Your City';
    } catch (error) {
      console.error('Error loading geo data:', error);
      this.geoData = { state: 'Your State', city: 'Your City' };
    }
  }

  async loadArticle(slug) {
    const url = `${this.apiBase}/pp-articles/?filters[slug][$eq]=${slug}&populate=*&pagination[pageSize]=1`;
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${this.apiToken}`
      }
    });

    if (!response.ok) {
      throw new Error(`Failed to fetch article: ${response.status}`);
    }

    const data = await response.json();
    
    if (!data.data || data.data.length === 0) {
      throw new Error('Article not found');
    }

    this.articleData = data.data[0].attributes;
  }

  renderArticle() {
    if (!this.articleData) return;

    // Hide loading, show content
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('articleContent').style.display = 'block';

    // Set page title
    const title = this.replaceTokens(this.articleData.title || this.articleData.title_without_tokens);
    document.getElementById('pageTitle').textContent = title;
    document.getElementById('title').textContent = title;

    // Set date (3 days ago)
    const date = new Date();
    date.setDate(date.getDate() - 3);
    document.getElementById('date').textContent = date.toLocaleDateString('en-US', {
      month: 'long',
      day: '2-digit',
      year: 'numeric'
    });

    // Set featured image if available
    if (this.articleData.featured_image?.data?.attributes) {
      const imageData = this.articleData.featured_image.data.attributes;
      const imageUrl = imageData.url || imageData.formats?.large?.url || imageData.formats?.medium?.url;
      
      if (imageUrl) {
        const heroContainer = document.getElementById('heroContainer');
        const featuredImage = document.getElementById('featuredImage');
        featuredImage.src = imageUrl;
        featuredImage.alt = imageData.alternativeText || title;
        heroContainer.style.display = 'block';
      }
    }

    // Check for image override in URL params
    const urlParams = new URLSearchParams(window.location.search);
    const fimg = urlParams.get('fimg');
    if (fimg) {
      document.getElementById('featuredImage').src = fimg;
      document.getElementById('heroContainer').style.display = 'block';
    }

    // Render main content
    const content = this.processContent(this.articleData.main_content);
    document.getElementById('content').innerHTML = content;

    // Update all CTA links
    this.updateCTALinks();

    // Show ZIP section if using ZipCodes component
    if (this.articleData.cta_component === 'ZipCodes') {
      document.getElementById('zipSection').style.display = 'block';
    }

    // Set up popunder if enabled
    if (this.articleData.display_popunder && this.articleData.popunder_url) {
      this.setupPopunder(this.articleData.popunder_url);
    }
  }

  processContent(markdown) {
    // Convert markdown to HTML (enhanced conversion with table support)
    let html = markdown;
    
    // Replace tokens
    html = this.replaceTokens(html);
    
    // Process markdown tables FIRST (before other conversions)
    html = this.processMarkdownTables(html);
    
    // Convert markdown syntax to HTML
    // Headers
    html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
    
    // Bold and italic
    html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Links with custom text
    html = html.replace(/\[([^\]]+)\]\(link\)/g, (match, text) => {
      const url = this.articleData.cta_url || '#';
      const offerName = this.articleData.offer_name || text;
      return `<a class="ctaLink" href="${url}" target="_blank" rel="noopener">${text.replace('{offer_name}', offerName)}</a>`;
    });
    
    // Regular links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    
    // Bullet lists
    html = html.replace(/^[\*\-]\s+(.*?)$/gm, '<li>$1</li>');
    
    // Numbered lists
    html = html.replace(/^\d+\)\s+(.*?)$/gm, '<li>$1</li>');
    html = html.replace(/^\d+\.\s+(.*?)$/gm, '<li>$1</li>');
    
    // Wrap consecutive list items
    html = html.replace(/(<li>.*?<\/li>\s*)+/gs, (match) => {
      // Check if it's numbered or bulleted based on original markdown
      return `<ol>${match}</ol>`;
    });
    
    // Paragraphs (but not for content already in HTML tags)
    html = html.split('\n\n').map(para => {
      para = para.trim();
      if (para && !para.startsWith('<') && !para.match(/^[\d]+\./) && !para.match(/^[\*\-]\s/)) {
        return `<p>${para}</p>`;
      }
      return para;
    }).join('\n\n');
    
    // Clean up
    html = html.replace(/\n{3,}/g, '\n\n');
    
    return html;
  }

  processMarkdownTables(text) {
    // Find markdown tables and convert them to HTML
    const tableRegex = /\|(.+)\|\n\|[\s\-\|]+\|\n((?:\|.+\|\n?)+)/gm;
    
    return text.replace(tableRegex, (match, headerRow, bodyRows) => {
      // Process header
      const headers = headerRow.split('|').filter(h => h.trim()).map(h => h.trim());
      
      // Process body rows
      const rows = bodyRows.trim().split('\n').map(row =>
        row.split('|').filter(cell => cell !== undefined && cell !== '').map(cell => cell.trim())
      );
      
      // Build HTML table with wrapper for mobile responsiveness
      let tableHtml = '<div class="table-wrapper"><table>';
      
      // Add header
      tableHtml += '<thead><tr>';
      headers.forEach(header => {
        tableHtml += `<th>${header}</th>`;
      });
      tableHtml += '</tr></thead>';
      
      // Add body
      tableHtml += '<tbody>';
      rows.forEach(row => {
        if (row.length > 0) {
          tableHtml += '<tr>';
          row.forEach((cell, index) => {
            // Add data-label for mobile responsiveness
            const label = headers[index] || '';
            tableHtml += `<td data-label="${label}">${cell || ''}</td>`;
          });
          tableHtml += '</tr>';
        }
      });
      tableHtml += '</tbody>';
      
      tableHtml += '</table></div>';
      
      return tableHtml;
    });
  }

  replaceTokens(text) {
    if (!text) return text;
    
    const state = this.geoData.state || 'Your State';
    const city = this.geoData.city || 'Your City';
    const offerName = this.articleData.offer_name || 'this service';
    
    return text
      .replace(/\{state\}/g, state)
      .replace(/\{city\}/g, city)
      .replace(/\{offer_name\}/g, offerName);
  }

  updateCTALinks() {
    const ctaUrl = this.articleData.cta_url || '#';
    const ctaLinks = document.querySelectorAll('.ctaLink, .btn');
    
    ctaLinks.forEach(link => {
      if (link.href === '#' || link.href.includes('link')) {
        link.href = ctaUrl;
      }
    });
  }

  async loadZipCodes() {
    const container = document.getElementById('zips');
    if (!container) return;
    
    try {
      const response = await fetch('https://api.pennypincher.com/zipcode-radius');
      if (!response.ok) throw new Error('Failed to fetch ZIP codes');
      
      const data = await response.json();
      const zipCodes = data.zip_codes || [];
      
      // Sort and render ZIP codes
      zipCodes
        .sort((a, b) => a.zip_code.localeCompare(b.zip_code))
        .forEach(zip => {
          const link = document.createElement('a');
          link.className = 'zip';
          link.href = this.articleData.cta_url || '#';
          link.target = '_blank';
          link.rel = 'noopener';
          link.textContent = zip.zip_code;
          container.appendChild(link);
        });
    } catch (error) {
      console.error('Error loading ZIP codes:', error);
      container.innerHTML = '<span style="color:#fca5a5">ZIP list unavailable. Try again later.</span>';
    }
  }

  setupPopunder(url) {
    let popunderShown = false;
    
    const showPopunder = () => {
      if (popunderShown) return;
      popunderShown = true;
      
      window.open(url, '_blank');
    };
    
    // Trigger on various user interactions
    document.addEventListener('click', showPopunder, { once: true });
    document.addEventListener('scroll', () => {
      if (window.scrollY > 100) showPopunder();
    }, { once: true });
  }

  showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    const errorElement = document.getElementById('errorState');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
  }
}

// Initialize the article loader
const loader = new ArticleLoader();
loader.init();
</script>
</body>
</html>