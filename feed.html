<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Latest Articles - Penny Pincher</title>
<style>
  :root{
    --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa4b2; --line:#1b2330;
    --brand:#f59e0b; --brand-2:#16a34a; --link:#93c5fd; --chip:#0f1720;
    --card:#0e141b; --accent:#ffe08a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{background:var(--bg);color:var(--ink);font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  img{max-width:100%;height:auto;display:block}
  .wrap{max-width:1120px;margin:auto;padding:20px}
  .content-wrap{max-width:600px;margin:auto;padding:20px}
  header,footer{background:#0a0f15;border-bottom:1px solid var(--line)}
  header .bar{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
  .title{font-weight:900;letter-spacing:-.01em;line-height:1.15;margin:20px 0 8px}
  .title.xl{font-size:clamp(28px,5vw,48px)}
  .subtitle{color:var(--muted);font-size:18px;margin-bottom:32px}
  
  /* X/Twitter-style feed */
  .feed-container{max-width:600px;margin:0 auto}
  .article-card{background:var(--card);border:1px solid var(--line);border-radius:0;margin-bottom:-1px;transition:background-color 0.2s}
  .article-card:first-child{border-top-left-radius:12px;border-top-right-radius:12px}
  .article-card:last-child{border-bottom-left-radius:12px;border-bottom-right-radius:12px;margin-bottom:16px}
  .article-card:hover{background:rgba(255,255,255,0.02)}
  
  .article-link{display:block;padding:16px;color:inherit;text-decoration:none}
  .article-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
  .article-meta{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px}
  .article-date{color:var(--muted)}
  .article-title{font-size:20px;font-weight:600;margin:8px 0;line-height:1.3;color:var(--ink)}
  .article-excerpt{color:var(--muted);font-size:15px;line-height:1.5;margin-bottom:12px}
  .article-image{width:100%;border-radius:12px;margin-top:12px;background:var(--chip);aspect-ratio:16/9;object-fit:cover}
  .article-footer{display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--line)}
  .read-time{font-size:13px;color:var(--muted)}
  .read-more-link{font-size:13px;color:var(--brand);font-weight:500}
  
  /* Mobile responsive */
  @media(max-width:600px){
    .content-wrap{padding:12px}
    .article-link{padding:12px}
    .article-title{font-size:18px}
    .article-excerpt{font-size:14px}
  }
  
  .loading{text-align:center;padding:40px;color:var(--muted)}
  .error{background:#7f1d1d;color:#fca5a5;padding:20px;border-radius:12px;margin:20px 0}
  .load-more{display:block;width:100%;max-width:200px;margin:32px auto;padding:12px 24px;background:var(--chip);border:1px solid var(--line);border-radius:24px;color:var(--ink);cursor:pointer;transition:0.2s;text-align:center;font-weight:600}
  .load-more:hover{background:var(--brand);color:#000}
  .load-more:disabled{opacity:0.5;cursor:not-allowed}
  .logo{height:28px}
  .foot{color:#98a2b3;font-size:13px;margin-top:18px}
  .center{text-align:center}
  .no-more{text-align:center;color:var(--muted);padding:20px;font-size:14px}
  
  /* Divider between sections */
  .feed-section{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-bottom:16px}
</style>
</head>
<body>
<header>
  <div class="wrap bar">
    <a href="https://pennypincher.com"><img class="logo" src="logo.svg" alt="Penny Pincher"></a>
  </div>
</header>

<main class="content-wrap">
  <h1 class="title xl">Latest Articles</h1>
  <p class="subtitle">Expert money-saving tips and financial advice</p>

  <div id="loadingState" class="loading">Loading articles...</div>
  <div id="errorState" class="error" style="display:none"></div>
  
  <div class="feed-section" id="feedSection" style="display:none">
    <div class="feed-container" id="feedContainer"></div>
  </div>
  
  <button class="load-more" id="loadMoreBtn" onclick="feedLoader.loadMore()" style="display:none">
    Load More
  </button>
  
  <div class="no-more" id="noMore" style="display:none">
    You've reached the end
  </div>
</main>

<footer>
  <div class="wrap">
    <hr><br>
    <div class="center"><a href="https://pennypincher.com"><img class="logo" src="logo.svg" alt="Penny Pincher"></a></div>
    <p class="foot center">© 2025 PennyPincher.com. All Rights Reserved. &nbsp; <a href="/privacy-policy">Privacy</a> · <a href="/terms-of-use">Terms</a> · <a href="/contact">Contact</a></p>
  </div>
</footer>

<script type="module">
// X/Twitter-style Feed Loader for Finance articles only
class FeedLoader {
  constructor() {
    this.apiBase = 'https://strapi-advertorials-xrppc.ondigitalocean.app/api';
    this.apiToken = '7b1cdd7dec14d838179aa383e0686ccf4c171ddf1c0c256127108901d3885db31ca6548a478064cd9c6272beecf86bc2fb297c5185ceedd92b563131ddd3def956321421de8b6ef607b0c2b19f86edc6693ab6e02486ebd49d5c9366f1fead150cbc64938aa7f3ed630d311837c2c3b03ecfc79ad02b085eea50b251ba9f603c';
    this.articles = [];
    this.currentPage = 1;
    this.pageSize = 20;
    this.totalPages = 1;
    this.isLoading = false;
    this.geoData = {};
  }

  async init() {
    try {
      await this.loadGeoData();
      await this.loadArticles();
      this.setupInfiniteScroll();
    } catch (error) {
      console.error('Error initializing feed:', error);
      this.showError('Failed to load articles. Please try again later.');
    }
  }

  async loadGeoData() {
    try {
      const url = new URL(location.href);
      const stateFromUrl = url.searchParams.get('state');
      const cityFromUrl = url.searchParams.get('city');
      
      if (stateFromUrl) this.geoData.state = stateFromUrl;
      if (cityFromUrl) this.geoData.city = cityFromUrl;
      
      if (!this.geoData.state || !this.geoData.city) {
        const cachedState = localStorage.getItem('geoState');
        const cachedCity = localStorage.getItem('geoCity');
        
        if (cachedState) this.geoData.state = cachedState;
        if (cachedCity) this.geoData.city = cachedCity;
        
        if (!this.geoData.state || !this.geoData.city) {
          try {
            const response = await fetch('https://api.pennypincher.com/geo');
            if (response.ok) {
              const data = await response.json();
              if (data.state) {
                this.geoData.state = data.state;
                localStorage.setItem('geoState', data.state);
              }
              if (data.city) {
                this.geoData.city = data.city;
                localStorage.setItem('geoCity', data.city);
              }
            }
          } catch (e) {
            console.warn('Could not fetch geo data:', e);
          }
        }
      }
      
      if (!this.geoData.state) this.geoData.state = 'Your State';
      if (!this.geoData.city) this.geoData.city = 'Your City';
    } catch (error) {
      console.error('Error loading geo data:', error);
      this.geoData = { state: 'Your State', city: 'Your City' };
    }
  }

  async loadArticles(append = false) {
    if (this.isLoading) return;
    this.isLoading = true;
    
    try {
      if (!append) {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('feedSection').style.display = 'none';
      }
      
      // Only fetch finance articles
      let url = `${this.apiBase}/pp-articles?populate=featured_image&pagination[page]=${this.currentPage}&pagination[pageSize]=${this.pageSize}&sort=createdAt:desc&filters[vertical][$eq]=finance`;
      
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${this.apiToken}`
        }
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch articles: ${response.status}`);
      }

      const data = await response.json();
      const newArticles = data.data || [];
      
      if (append) {
        this.articles = [...this.articles, ...newArticles];
      } else {
        this.articles = newArticles;
      }
      
      const pagination = data.meta?.pagination;
      if (pagination) {
        this.totalPages = pagination.pageCount;
        this.currentPage = pagination.page;
      }
      
      this.renderArticles(append);
      
      if (!append) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('feedSection').style.display = 'block';
      }
      
      this.updateLoadMoreButton();
      
    } catch (error) {
      console.error('Error loading articles:', error);
      if (!append) {
        this.showError('Failed to load articles. Please try again later.');
      }
    } finally {
      this.isLoading = false;
    }
  }

  renderArticles(append = false) {
    const container = document.getElementById('feedContainer');
    
    if (!append) {
      container.innerHTML = '';
    }
    
    if (this.articles.length === 0 && !append) {
      container.innerHTML = '<div style="text-align:center; color:var(--muted); padding:40px;">No articles found.</div>';
      return;
    }
    
    const startIndex = append ? this.articles.length - this.pageSize : 0;
    const articlesToRender = append ? this.articles.slice(startIndex) : this.articles;
    
    articlesToRender.forEach(article => {
      const attrs = article.attributes;
      const card = this.createArticleCard(attrs);
      container.appendChild(card);
    });
  }

  createArticleCard(article) {
    const card = document.createElement('article');
    card.className = 'article-card';
    
    // Get image URL
    let imageUrl = '';
    if (article.featured_image?.data?.attributes) {
      const imageData = article.featured_image.data.attributes;
      imageUrl = imageData.formats?.large?.url || imageData.formats?.medium?.url || imageData.url;
    }
    
    const title = this.replaceTokens(article.title || article.title_without_tokens);
    const excerpt = this.extractExcerpt(article.main_content);
    
    // Calculate reading time
    const wordCount = article.main_content ? article.main_content.split(/\s+/).length : 0;
    const readingTime = Math.ceil(wordCount / 200);
    
    // Format date
    const date = new Date(article.createdAt);
    const timeAgo = this.getTimeAgo(date);
    
    const articleUrl = `/${article.slug}`;
    
    // Build card HTML - X/Twitter style
    let cardHTML = `
      <a href="${articleUrl}" class="article-link">
        <div class="article-header">
          <div class="article-meta">
            <span class="article-date">${timeAgo}</span>
          </div>
        </div>
        <h2 class="article-title">${title}</h2>
        <p class="article-excerpt">${excerpt}</p>
    `;
    
    // Add image if available
    if (imageUrl) {
      cardHTML += `<img class="article-image" src="${imageUrl}" alt="${title}" loading="lazy">`;
    }
    
    cardHTML += `
        <div class="article-footer">
          <span class="read-time">${readingTime} min read</span>
          <span class="read-more-link">Read more →</span>
        </div>
      </a>
    `;
    
    card.innerHTML = cardHTML;
    
    return card;
  }

  getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + 'y';
    
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + 'mo';
    
    interval = seconds / 604800;
    if (interval > 1) return Math.floor(interval) + 'w';
    
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + 'd';
    
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + 'h';
    
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + 'm';
    
    return 'now';
  }

  extractExcerpt(content, maxLength = 200) {
    if (!content) return 'Discover money-saving tips and financial insights in this article.';
    
    let text = content
      .replace(/\*\*(.*?)\*\*/g, '$1')
      .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
      .replace(/^#+\s+/gm, '')
      .replace(/^\d+\.\s+/gm, '')
      .replace(/\n+/g, ' ')
      .trim();
    
    text = this.replaceTokens(text);
    
    if (text.length > maxLength) {
      text = text.substring(0, maxLength).trim() + '...';
    }
    
    return text;
  }

  replaceTokens(text) {
    if (!text) return text;
    
    const state = this.geoData.state || 'Your State';
    const city = this.geoData.city || 'Your City';
    
    return text
      .replace(/\{state\}/g, state)
      .replace(/\{city\}/g, city);
  }

  updateLoadMoreButton() {
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const noMore = document.getElementById('noMore');
    
    if (this.currentPage >= this.totalPages) {
      loadMoreBtn.style.display = 'none';
      noMore.style.display = 'block';
    } else {
      loadMoreBtn.style.display = 'block';
      noMore.style.display = 'none';
      loadMoreBtn.disabled = false;
    }
  }

  async loadMore() {
    if (this.currentPage < this.totalPages && !this.isLoading) {
      this.currentPage++;
      await this.loadArticles(true);
    }
  }

  setupInfiniteScroll() {
    // Auto-load when scrolling near bottom
    window.addEventListener('scroll', () => {
      if (this.isLoading) return;
      
      const scrollPosition = window.innerHeight + window.scrollY;
      const threshold = document.body.offsetHeight - 500;
      
      if (scrollPosition >= threshold && this.currentPage < this.totalPages) {
        this.loadMore();
      }
    });
  }

  showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('feedSection').style.display = 'none';
    const errorElement = document.getElementById('errorState');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
  }
}

// Initialize the feed loader
window.feedLoader = new FeedLoader();
feedLoader.init();
</script>
</body>
</html>